<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulaci√≥n de N√∫cleos At√≥micos - Rust + WebAssembly</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            align-items: flex-start;
            background: #f0f0f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 10px;
        }

        .controls {
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
            margin-right: 10px;
            width: 300px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .controls h3 {
            color: #4CAF50;
            margin: 15px 0 10px 0;
            font-size: 16px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }

        button {
            padding: 10px 15px;
            margin: 4px 0;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            width: 100%;
            transition: background 0.3s;
        }

        button:hover {
            background: #45a049;
        }

        .particle-btn {
            background: #2196F3;
        }

        .particle-btn:hover {
            background: #0b7dda;
        }

        .clear-btn {
            background: #f44336;
        }

        .clear-btn:hover {
            background: #da190b;
        }

        .control-group {
            margin: 8px 0;
            color: #ccc;
            font-size: 12px;
        }

        .control-group label {
            display: block;
            margin-bottom: 4px;
            color: #fff;
        }

        .control-group input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        .controls-section {
            border-top: 1px solid #444;
            padding: 8px 0;
            margin: 5px 0;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #particleCanvas {
            border: 2px solid #333;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            background: #000;
        }

        #status {
            color: #4CAF50;
            font-weight: bold;
            text-align: center;
            font-size: 16px;
        }

        .element-info {
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 8px;
            color: #ccc;
            max-height: 90vh;
            overflow-y: auto;
            min-width: 200px;
            font-size: 12px;
        }

        .element-info h3 {
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .element-info ul {
            list-style: none;
            padding-left: 10px;
        }

        .element-info li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h3>Part√≠culas</h3>
        <div class="controls-section">
            <button class="particle-btn" onclick="addSingleParticle(0)">+ Prot√≥n</button>
            <button class="particle-btn" onclick="addSingleParticle(1)">+ Neutr√≥n</button>
            <button class="particle-btn" onclick="addSingleParticle(2)">+ Electr√≥n</button>
        </div>

        <h3>√Åtomos</h3>
        <div class="controls-section">
            <button onclick="addNucleus(1, 0, 1)">+ Hidr√≥geno (H)</button>
            <button onclick="addNucleus(2, 2, 2)">+ Helio (He)</button>
            <button onclick="addNucleus(3, 4, 3)">+ Litio (Li)</button>
            <button onclick="addNucleus(4, 5, 4)">+ Berilio (Be)</button>
            <button onclick="addNucleus(6, 6, 6)">+ Carbono (C)</button>
            <button onclick="addNucleus(8, 8, 8)">+ Ox√≠geno (O)</button>
        </div>

        <div class="controls-section">
            <button class="clear-btn" onclick="clearCanvas()">üóëÔ∏è Limpiar Todo</button>
        </div>

        <h3>Fuerzas Nucleares</h3>
        <div class="controls-section">
            <div class="control-group">
                <label>Fuerza Nuclear: <span class="value-display" id="nuclearForceValue">25.0</span></label>
                <input type="range" id="nuclearForce" min="0" max="50" value="25" step="0.5" oninput="updateParam('nuclear_force')">
            </div>
            <div class="control-group">
                <label>Rango Nuclear: <span class="value-display" id="nuclearRangeValue">40</span></label>
                <input type="range" id="nuclearRange" min="20" max="150" value="40" step="1" oninput="updateParam('nuclear_range')">
            </div>
        </div>

        <h3>Interacciones</h3>
        <div class="controls-section">
            <div class="control-group">
                <label>Fuerza Coulomb: <span class="value-display" id="coulombForceValue">3.0</span></label>
                <input type="range" id="coulombForce" min="0" max="10" value="3" step="0.1" oninput="updateParam('coulomb_force')">
            </div>
            <div class="control-group">
                <label>Repulsi√≥n P-P: <span class="value-display" id="protonRepulsionValue">15.0</span></label>
                <input type="range" id="protonRepulsion" min="0" max="30" value="15" step="0.5" oninput="updateParam('proton_repulsion')">
            </div>
        </div>
    </div>

    <div class="canvas-container">
        <div id="status">‚è≥ Cargando WebAssembly...</div>
        <canvas id="particleCanvas" width="1200" height="800" style="display:none;"></canvas>
    </div>

    <div class="element-info">
        <h3>Estado Actual</h3>
        <div>Part√≠culas:
            <ul>
                <li>Protones: <strong id="protonCount">0</strong></li>
                <li>Neutrones: <strong id="neutronCount">0</strong></li>
                <li>Electrones: <strong id="electronCount">0</strong></li>
            </ul>
        </div>
        <div>Total N√∫cleos: <strong id="nucleiCount">0</strong></div>
    </div>

    <script>
        let engine = null;
        let canvas = null;
        let ctx = null;
        let animationId = null;
        let isRunning = false;

        async function initWasm() {
            try {
                // Fetch and instantiate WASM manually
                const wasmResponse = await fetch('./pkg/atomic_particles_simulation_bg.wasm');
                if (!wasmResponse.ok) {
                    throw new Error(`Failed to fetch WASM: ${wasmResponse.status}`);
                }

                const wasmBuffer = await wasmResponse.arrayBuffer();
                
                // Create memory and table objects for WASM
                const memory = new WebAssembly.Memory({ initial: 256, maximum: 512 });
                const table = new WebAssembly.Table({ initial: 1, maximum: 1, element: 'anyfunc' });

                // Instantiate WASM with imports
                const imports = {
                    env: {
                        memory: memory,
                        table: table,
                    },
                    __wbindgen_placeholder__: {}
                };

                let wasmModule;
                try {
                    wasmModule = await WebAssembly.instantiate(wasmBuffer, imports);
                } catch (e) {
                    // Try without specific imports structure
                    wasmModule = await WebAssembly.instantiate(wasmBuffer);
                }

                // Now load the JavaScript bindings
                const bindingsResponse = await fetch('./pkg/atomic_particles_simulation_bg.js');
                const bindingsText = await bindingsResponse.text();
                
                // Create a blob URL for the bindings
                const bindingsBlob = new Blob([bindingsText], { type: 'application/javascript' });
                const bindingsUrl = URL.createObjectURL(bindingsBlob);

                // Import the bindings module
                const bindingsModule = await import(bindingsUrl);
                const { SimulationEngine } = bindingsModule;

                canvas = document.getElementById('particleCanvas');
                ctx = canvas.getContext('2d');

                engine = new SimulationEngine(canvas.width, canvas.height);

                // Initial particles
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                engine.add_particle(centerX, centerY, 0);
                engine.add_particle(centerX + 50, centerY, 1);

                document.getElementById('status').innerHTML = '‚úÖ WebAssembly Cargado - Simulaci√≥n Activa';
                document.getElementById('status').style.color = '#4CAF50';
                canvas.style.display = 'block';

                isRunning = true;
                animate();

            } catch (err) {
                document.getElementById('status').innerHTML = `‚ùå Error: ${err.message}`;
                document.getElementById('status').style.color = '#f44336';
                console.error('Error loading WASM:', err);
                console.error('Stack:', err.stack);
            }
        }

        function animate() {
            if (!isRunning || !engine) return;

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            engine.update();
            engine.render(ctx);

            updateInfo();

            animationId = requestAnimationFrame(animate);
        }

        function updateInfo() {
            if (!engine) return;

            const particleCount = engine.get_particle_count();
            let protons = 0, neutrons = 0, electrons = 0;

            for (let i = 0; i < particleCount; i++) {
                const dataStr = engine.get_particle_data(i);
                if (dataStr) {
                    const data = JSON.parse(dataStr);
                    switch (data.type) {
                        case 0: protons++; break;
                        case 1: neutrons++; break;
                        case 2: electrons++; break;
                    }
                }
            }

            document.getElementById('protonCount').textContent = protons;
            document.getElementById('neutronCount').textContent = neutrons;
            document.getElementById('electronCount').textContent = electrons;

            const nucleiData = engine.get_nuclei_data();
            const nuclei = JSON.parse(nucleiData);
            document.getElementById('nucleiCount').textContent = nuclei.length;
        }

        window.addSingleParticle = function(type) {
            if (!engine) return;
            const x = Math.random() * (canvas.width - 40) + 20;
            const y = Math.random() * (canvas.height - 40) + 20;
            engine.add_particle(x, y, type);
        };

        window.addNucleus = function(protons, neutrons, electrons) {
            if (!engine) return;
            const x = Math.random() * (canvas.width - 200) + 100;
            const y = Math.random() * (canvas.height - 200) + 100;
            engine.add_nucleus(x, y, protons, neutrons, electrons);
        };

        window.clearCanvas = function() {
            if (!engine) return;
            engine.clear();
            updateInfo();
        };

        window.updateParam = function(paramName) {
            if (!engine) return;

            const valueMap = {
                'nuclear_force': 'nuclearForce',
                'nuclear_range': 'nuclearRange',
                'coulomb_force': 'coulombForce',
                'proton_repulsion': 'protonRepulsion'
            };

            const inputId = valueMap[paramName];
            if (!inputId) return;

            const valueId = inputId + 'Value';
            const inputElement = document.getElementById(inputId);
            const valueElement = document.getElementById(valueId);

            if (inputElement && valueElement) {
                const value = parseFloat(inputElement.value);
                valueElement.textContent = value.toFixed(value < 1 ? 3 : 1);

                const methodName = 'set_' + paramName;
                if (typeof engine[methodName] === 'function') {
                    engine[methodName](value);
                }
            }
        };

        window.addEventListener('load', initWasm);
    </script>
</body>
</html>
